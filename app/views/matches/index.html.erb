<header class="page-header">
  <div class="page-header-container">
    <div class="flex w-12 shrink-0 items-center justify-start">
      <%= link_to leaderboard_path(:show), class: "page-header-button" do %>
        <span class="material-symbols-outlined text-2xl">trophy</span>
      <% end %>
    </div>
    <h1 class="page-title">World Cup Matches</h1>
    <div class="flex w-12 items-center justify-end">
      <button onclick="location.reload()" class="page-header-button">
        <span class="material-symbols-outlined text-2xl">refresh</span>
      </button>
    </div>
  </div>
</header>

<nav class="tab-nav">
  <div class="tab-nav-container">
    <%= form_with url: matches_path, method: :get, local: true, id: 'filter-form' do %>
      <%= hidden_field_tag 'filter[PostEvent]', @filter_params['PostEvent'] || '0', id: 'filter_PostEvent' %>
      <%= hidden_field_tag 'filter[MidEvent]', @filter_params['MidEvent'] || '0', id: 'filter_MidEvent' %>
      <%= hidden_field_tag 'filter[PreEvent]', @filter_params['PreEvent'] || '0', id: 'filter_PreEvent' %>

      <div class="tab-nav-items">
        <a href="javascript:void(0)" onclick="applyFilter('MidEvent')" class="tab-nav-item <%= @filter_params['MidEvent'] == '1' ? 'active' : '' %>">
          <p class="tab-nav-label">Live</p>
        </a>
        <a href="javascript:void(0)" onclick="applyFilter('PreEvent')" class="tab-nav-item <%= @filter_params['PreEvent'] == '1' ? 'active' : '' %>">
          <p class="tab-nav-label">Upcoming</p>
        </a>
        <a href="javascript:void(0)" onclick="applyFilter('PostEvent')" class="tab-nav-item <%= @filter_params['PostEvent'] == '1' ? 'active' : '' %>">
          <p class="tab-nav-label">Finished</p>
        </a>
      </div>
    <% end %>
  </div>
</nav>

<main class="flex-1 px-4 pb-24">
  <!-- Ben Motson Commentary -->
  <% if @matches.present? && (@filter_params['MidEvent'] == '1' || @filter_params['PostEvent'] == '1') %>
    <div class="py-6">
      <div class="commentary-box">
        <div class="commentary-header">
          <i class="fas fa-microphone commentary-icon"></i>
          <h3 class="commentary-title">Ben Motson's Commentary</h3>
        </div>
        <p class="commentary-text">
          <% if @filter_params['MidEvent'] == '1' %>
            <%= @matches.count %> <%= 'match'.pluralize(@matches.count) %> currently in progress! The action is heating up across the tournament.
          <% else %>
            <%= @matches.count %> <%= 'match'.pluralize(@matches.count) %> completed. Check out the results below!
          <% end %>
        </p>
      </div>
    </div>
  <% end %>

  <% if @error_message %>
    <div class="text-center py-16">
      <div class="inline-flex items-center justify-center h-16 w-16 rounded-full bg-primary/10 mb-4">
        <span class="material-symbols-outlined text-primary text-4xl">error</span>
      </div>
      <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">Error Loading Matches</h3>
      <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1"><%= @error_message %></p>
    </div>
  <% elsif @matches.empty? %>
    <div class="text-center py-16">
      <div class="inline-flex items-center justify-center h-16 w-16 rounded-full bg-primary/10 mb-4">
        <span class="material-symbols-outlined text-primary text-4xl">sports_soccer</span>
      </div>
      <h3 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark">No Matches Found</h3>
      <p class="text-sm text-text-secondary-light dark:text-text-secondary-dark mt-1">Check back later or view other games.</p>
    </div>
  <% else %>
    <% # Group matches by date (most recent first) %>
    <% matches_by_date = @matches.group_by { |m| m.start_time.to_date } %>
    <% matches_by_date.sort.reverse.each do |date, matches| %>
      <% matches = matches.sort_by(&:start_time).reverse %>
      <% if date == Date.today %>
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] text-text-primary-light dark:text-text-primary-dark pb-2 pt-6">TODAY</h2>
      <% elsif date == Date.tomorrow %>
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] text-text-primary-light dark:text-text-primary-dark pb-2 pt-6">TOMORROW, <%= date.strftime('%d %b').upcase %></h2>
      <% else %>
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] text-text-primary-light dark:text-text-primary-dark pb-2 pt-6"><%= date.strftime('%A, %d %b').upcase %></h2>
      <% end %>

      <% matches.each do |match| %>
        <div class="py-2">
          <div class="match-card">
            <div class="match-header">
              <span><%= match.stage %></span>
              <% if match.status == 'MidEvent' %>
                <div class="match-status-live">
                  <div class="pulse-dot"></div>
                  <span>LIVE</span>
                </div>
              <% elsif match.status == 'PostEvent' %>
                <span class="font-bold text-text-primary-light dark:text-text-primary-dark">FT</span>
              <% else %>
                <span class="font-bold text-text-primary-light dark:text-text-primary-dark"><%= match.start_time.strftime('%H:%M') %></span>
              <% end %>
            </div>

            <div class="flex items-center justify-between">
              <!-- Home Team -->
              <div class="match-team">
                <% if match.home_friend_profile_picture_url.present? %>
                  <%= image_tag match.home_friend_profile_picture_url, alt: match.home_friend_name, class: "h-8 w-8 object-cover rounded-full" %>
                <% else %>
                  <div class="match-team-avatar">
                    <span class="match-team-avatar-initial"><%= match.home_team.name[0] %></span>
                  </div>
                <% end %>
                <div class="flex flex-col">
                  <span class="match-team-name"><%= match.home_team.name %></span>
                  <% if match.home_friend_name != 'No owner' %>
                    <span class="match-team-owner"><%= match.home_friend_name %></span>
                  <% end %>
                </div>
              </div>

              <!-- Score or VS -->
              <% if match.status == 'PreEvent' %>
                <span class="match-vs">vs</span>
              <% else %>
                <span class="match-score"><%= match.home_score %> - <%= match.away_score %></span>
              <% end %>

              <!-- Away Team -->
              <div class="match-team justify-end">
                <div class="flex flex-col items-end">
                  <span class="match-team-name text-right"><%= match.away_team.name %></span>
                  <% if match.away_friend_name != 'No owner' %>
                    <span class="match-team-owner"><%= match.away_friend_name %></span>
                  <% end %>
                </div>
                <% if match.away_friend_profile_picture_url.present? %>
                  <%= image_tag match.away_friend_profile_picture_url, alt: match.away_friend_name, class: "h-8 w-8 object-cover rounded-full" %>
                <% else %>
                  <div class="match-team-avatar">
                    <span class="match-team-avatar-initial"><%= match.away_team.name[0] %></span>
                  </div>
                <% end %>
              </div>
            </div>

            <% if match.status == 'MidEvent' && match.accessible_event_summary.present? %>
              <div class="match-summary">
                <%= match.accessible_event_summary %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</main>

<%= render 'layouts/bottom_nav' %>

<script>
  function applyFilter(filterType) {
    document.getElementById('filter_PostEvent').value = (filterType === 'PostEvent') ? '1' : '0';
    document.getElementById('filter_MidEvent').value = (filterType === 'MidEvent') ? '1' : '0';
    document.getElementById('filter_PreEvent').value = (filterType === 'PreEvent') ? '1' : '0';
    document.getElementById('filter-form').submit();
  }
</script>
